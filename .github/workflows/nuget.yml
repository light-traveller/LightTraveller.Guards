name: Release to Nuget Pipeline

on:
  push:
    branches: [ 'master' ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  #pull_request:
    #branches: [ 'master' ]

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
        
    - name: Set VERSION variable from tag
      run: echo "VERSION=${GITHUB_REF/refs\/tags\/v/}" >> $GITHUB_ENV
    
    - name: DEBUG VERSION
      run: echo 'DEBUG VERSION:'${VERSION}
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build -c Release --no-restore /p:Version=${VERSION}
    
    - name: Test
      run: dotnet test -c Release --no-build --verbosity normal
    
    - name: Pack nuget
      run: dotnet pack -c Release --no-build --no-restore --output nupkgs /p:PackageVersion=${VERSION}
    
    - name: Upload to nuget.org
      if: github.ref_type == 'tag' && startsWith(github.ref, 'refs/tags/v')
      run: dotnet nuget push nupkgs/*.nupkg --api-key ${{secrets.NUGET_ORG}} --source https://api.nuget.org/v3/index.json
